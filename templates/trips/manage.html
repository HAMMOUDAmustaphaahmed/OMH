{% extends "base.html" %}

{% block styles %}
<link rel="stylesheet" href="https://cdn.datatables.net/1.10.24/css/dataTables.bootstrap4.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/1.7.0/css/buttons.bootstrap4.min.css">
<link rel="stylesheet" href="https://cdn.daterangepicker.com/daterangepicker.css">
<style>
/* Styles spécifiques pour la page de gestion */
.header-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
}

.btn-group .dropdown-menu {
    min-width: 200px;
    padding: 1rem;
}

.filters-section {
    background: white;
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.filter-group {
    display: flex;
    gap: 1rem;
    margin-bottom: 1rem;
}

.table-container {
    background: white;
    border-radius: 8px;
    padding: 1.5rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.dataTables_wrapper {
    padding: 1rem 0;
}

.status-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 15px;
    font-size: 0.875rem;
    font-weight: 500;
}

.trip-type {
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.875rem;
}

.action-buttons {
    display: flex;
    gap: 0.5rem;
}

.action-button {
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.2s;
}

.action-button:hover {
    transform: translateY(-1px);
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="header-actions">
        <h1>Gestion des Voyages</h1>
        
        <div class="btn-group">
            <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown">
                <i class="fas fa-plus"></i> Nouveau
            </button>
            <div class="dropdown-menu dropdown-menu-right">
                <a class="dropdown-item" href="{{ url_for('trips.add') }}">
                    <i class="fas fa-route"></i> Voyage normal
                </a>
                <a class="dropdown-item" href="{{ url_for('trips.add_vente') }}">
                    <i class="fas fa-percent"></i> Commission de vente
                </a>
            </div>
        </div>
    </div>
    
    <div class="filters-section">
        <div class="filter-group">
            <input type="text" id="searchInput" class="form-control" placeholder="Rechercher...">
            
            <select id="typeFilter" class="form-control">
                <option value="">Tous les types</option>
                <option value="Excursion">Excursion</option>
                <option value="Transfert">Transfert</option>
                <option value="Divers">Divers</option>
                <option value="Varié">Varié</option>
            </select>
            
            <input type="text" id="dateRange" class="form-control" placeholder="Période">
            
            <button id="resetFilters" class="btn btn-secondary">
                <i class="fas fa-undo"></i> Réinitialiser
            </button>
        </div>
    </div>
    
    <div class="table-container">
        <table id="tripsTable" class="table table-striped">
            <thead>
                <tr>
                    <th>Code</th>
                    <th>Nom</th>
                    <th>Type</th>
                    <th>Client</th>
                    <th>Date départ</th>
                    <th>Passagers</th>
                    <th>Tarif</th>
                    <th>Véhicules</th>
                    <th>Chauffeurs</th>
                    <th>Actions</th>
                </tr>
            </thead>
        </table>
    </div>
</div>

<!-- Modal de confirmation de suppression -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmer la suppression</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Êtes-vous sûr de vouloir supprimer ce voyage ?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">Supprimer</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.10.24/js/dataTables.bootstrap4.min.js"></script>
<script src="https://cdn.datatables.net/buttons/1.7.0/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/1.7.0/js/buttons.bootstrap4.min.js"></script>
<script src="https://cdn.daterangepicker.com/moment.min.js"></script>
<script src="https://cdn.daterangepicker.com/daterangepicker.js"></script>

<script>
$(document).ready(function() {
    // Initialisation de la table
    const table = $('#tripsTable').DataTable({
        serverSide: false,
        ajax: {
            url: "{{ url_for('trips.get_trips_data') }}",
            data: function(d) {
                d.search = $('#searchInput').val();
                d.type = $('#typeFilter').val();
                const dates = $('#dateRange').val().split(' - ');
                d.date_start = dates[0];
                d.date_end = dates[1];
            }
        },
        columns: [
            { data: 'code' },
            { data: 'nom' },
            { 
                data: 'type',
                render: function(data) {
                    return `<span class="trip-type ${data.toLowerCase()}">${data}</span>`;
                }
            },
            { data: 'client' },
            { data: 'date_depart' },
            { data: 'total_passagers' },
            { 
                data: 'tarif',
                render: function(data) {
                    return new Intl.NumberFormat('fr-FR', {
                        style: 'currency',
                        currency: 'EUR'
                    }).format(data);
                }
            },
            { 
                data: 'vehicules',
                render: function(data) {
                    return data.join(', ');
                }
            },
            { 
                data: 'chauffeurs',
                render: function(data) {
                    return data.join(', ');
                }
            },
            {
                data: 'id',
                render: function(data) {
                    return `
                        <div class="action-buttons">
                            <a href="/trips/edit/${data}" class="action-button btn-info">
                                <i class="fas fa-edit"></i>
                            </a>
                            <button onclick="confirmDelete(${data})" class="action-button btn-danger">
                                <i class="fas fa-trash"></i>
                            </button>
                            <button onclick="exportTrip(${data})" class="action-button btn-success">
                                <i class="fas fa-file-excel"></i>
                            </button>
                        </div>
                    `;
                }
            }
        ],
        order: [[0, 'desc']],
        language: {
            url: "//cdn.datatables.net/plug-ins/1.10.24/i18n/French.json"
        }
    });
    
    // Initialisation du date range picker
    $('#dateRange').daterangepicker({
        opens: 'left',
        locale: {
            format: 'YYYY-MM-DD'
        }
    });
    
    // Événements de filtrage
    $('#searchInput, #typeFilter, #dateRange').on('change', function() {
        table.ajax.reload();
    });
    
    $('#resetFilters').click(function() {
        $('#searchInput').val('');
        $('#typeFilter').val('');
        $('#dateRange').val('');
        table.ajax.reload();
    });
});

let tripIdToDelete = null;

function confirmDelete(id) {
    tripIdToDelete = id;
    $('#deleteModal').modal('show');
}

$('#confirmDelete').click(function() {
    if (tripIdToDelete) {
        $.ajax({
            url: `/trips/delete/${tripIdToDelete}`,
            method: 'POST',
            success: function() {
                $('#deleteModal').modal('hide');
                $('#tripsTable').DataTable().ajax.reload();
                showNotification('success', 'Voyage supprimé avec succès');
            },
            error: function() {
                showNotification('error', 'Erreur lors de la suppression');
            }
        });
    }
});

function exportTrip(id) {
    window.location.href = `/trips/export?id=${id}`;
}

function showNotification(type, message) {
    // Implement your notification system here
}
</script>
{% endblock %}